{% extends "layoutVentas.html" %}

{% block container %}
<div class="container-fluid">
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 py-4">
            <h4 class="text-center m-0">
                <i class="fas fa-cash-register me-2"></i>Historial de Ventas
            </h4>
        </div>
        <div class="card-body px-0">
            <div class="d-flex justify-content-center mb-4">
                <div class="d-flex align-items-center" style="max-width: 500px;">
                    <input type="date" class="form-control me-2" id="fecha_ventas">
                    <button class="btn btn-outline-secondary" onclick="listarVentas()">
                        <i class="fas fa-search me-1"></i> Buscar
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-borderless" id="tablaVentas" width="100%" cellspacing="0">
                    <thead>
                        <tr class="border-bottom">
                            <th>ID</th>
                            <th>Fecha/Hora</th>
                            <th class="text-end">Total</th>
                            <th class="text-center">Detalles</th>
                        </tr>
                    </thead>
                    <tbody id="lista_ventas" class="align-middle">
                        <!-- Las ventas se cargarán aquí -->
                    </tbody>
                    <tfoot class="border-top">
                        <tr>
                            <td colspan="2" class="text-end fw-bold">Total del día:</td>
                            <td id="totalDia" class="text-end fw-bold">$0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalles de venta -->
<div class="modal fade" id="modalDetalles" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title text-center w-100">
                    <i class="fas fa-receipt me-2"></i>Detalles de Venta
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-4 text-center">
                        <p class="mb-1"><small class="text-muted">ID Venta</small></p>
                        <p id="detalle-id" class="fw-bold"></p>
                    </div>
                    <div class="col-md-4 text-center">
                        <p class="mb-1"><small class="text-muted">Fecha</small></p>
                        <p id="detalle-fecha" class="fw-bold"></p>
                    </div>
                    <div class="col-md-4 text-center">
                        <p class="mb-1"><small class="text-muted">Total</small></p>
                        <p id="detalle-total" class="fw-bold"></p>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr class="border-bottom">
                                <th>Producto</th>
                                <th>Presentación</th>
                                <th class="text-end">Cantidad</th>
                                <th class="text-end">P. Unitario</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="detalle-productos">
                            <!-- Los productos se cargarán aquí -->
                        </tbody>
                        <tfoot class="border-top">
                            <tr>
                                <td colspan="4" class="text-end fw-bold">Total:</td>
                                <td class="text-end fw-bold" id="detalle-total-footer"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <p class="mb-1"><small class="text-muted">Monto Recibido</small></p>
                                <h5 id="detalle-recibido"></h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <p class="mb-1"><small class="text-muted">Cambio</small></p>
                                <h5 id="detalle-cambio"></h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-outline-dark" onclick="imprimirTicket()">
                    <i class="fas fa-print me-1"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

<!-- El script permanece exactamente igual -->
<script>
// Variable para almacenar la venta actual
let ventaActual = null;

async function listarVentas() {
    const fecha = document.getElementById("fecha_ventas").value;
    const url = fecha ? `/ventas/listar_ventas?fecha=${fecha}` : '/ventas/listar_ventas';
    
    try {
        const response = await fetch(url);
        const ventas = await response.json();

        if (ventas.error) {
            mostrarAlerta('error', ventas.error);
            return;
        }

        const tbody = document.getElementById("lista_ventas");
        tbody.innerHTML = "";

        let totalDia = 0;

        ventas.forEach(venta => {
            const total = parseFloat(venta.total) || 0;
            
            totalDia += total;

            tbody.innerHTML += `
                <tr class="border-bottom">
                    <td>${venta.id}</td>
                    <td>${venta.fecha}</td>
                    <td class="text-end">$${total.toFixed(2)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-dark" onclick="verDetalles(${venta.id})" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>`;
        });

        // Actualizar totales
        document.getElementById('totalDia').textContent = `$${totalDia.toFixed(2)}`;

    } catch (error) {
        console.error("Error en listarVentas:", error);
        mostrarAlerta('error', 'Error al cargar las ventas');
    }
}

async function verDetalles(idVenta) {
    try {
        const response = await fetch(`/ventas/detalles_venta/${idVenta}`);
        ventaActual = await response.json();

        if (ventaActual.error) {
            mostrarAlerta('error', ventaActual.error);
            return;
        }

        // Actualizar información básica
        document.getElementById('detalle-id').textContent = ventaActual.id;
        document.getElementById('detalle-fecha').textContent = ventaActual.fecha;
        document.getElementById('detalle-total').textContent = `$${parseFloat(ventaActual.total).toFixed(2)}`;
        document.getElementById('detalle-total-footer').textContent = `$${parseFloat(ventaActual.total).toFixed(2)}`;
        document.getElementById('detalle-recibido').textContent = `$${parseFloat(ventaActual.monto_recibido || 0).toFixed(2)}`;
        document.getElementById('detalle-cambio').textContent = `$${parseFloat(ventaActual.cambio || 0).toFixed(2)}`;

        // Llenar tabla de productos
        const tbody = document.getElementById("detalle-productos");
        tbody.innerHTML = "";

        ventaActual.detalles.forEach(detalle => {
            tbody.innerHTML += `
                <tr class="border-bottom">
                    <td>${detalle.galleta}</td>
                    <td>${detalle.presentacion}</td>
                    <td class="text-end">${detalle.cantidad}</td>
                    <td class="text-end">$${parseFloat(detalle.precio_unitario).toFixed(2)}</td>
                    <td class="text-end">$${parseFloat(detalle.subtotal).toFixed(2)}</td>
                </tr>`;
        });

        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalDetalles'));
        modal.show();

    } catch (error) {
        console.error("Error en verDetalles:", error);
        mostrarAlerta('error', 'Error al cargar los detalles');
    }
}

function imprimirTicket() {
    if (ventaActual) {
        window.open(`/ventas/ticket/${ventaActual.id}`, '_blank');
    }
}

function mostrarAlerta(tipo, mensaje) {
    // Implementar función de alertas bonitas (Toast, SweetAlert, etc.)
    alert(mensaje); // Temporal
}

// Cargar ventas del día actual al iniciar
document.addEventListener('DOMContentLoaded', function() {
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('fecha_ventas').value = hoy;
    listarVentas();
});
</script>

<style>
    #tablaVentas {
        border-collapse: separate;
        border-spacing: 0;
    }
    #tablaVentas th {
        font-weight: 500;
        white-space: nowrap;
        background-color: #f9f9f9;
    }
    .table-responsive {
        padding: 0 1rem;
    }
    .modal-header .modal-title {
        letter-spacing: 0.5px;
    }
    .btn-outline-dark:hover {
        background-color: #f8f9fa;
    }
    .card {
        border-radius: 0.5rem;
    }
</style>

{% endblock %}