{% extends "layoutVentas.html" %}
{% block container %}
<div class="card border-0 shadow-sm">
    <div class="card-header bg-transparent border-0 py-4">
        <h3 class="text-center m-0">
            <i class="fas fa-chart-bar me-2"></i>Corte de Ventas
        </h3>
    </div>
    <div class="card-body">
        <div class="row mb-4 justify-content-center">
            <div class="col-md-3 mb-2">
                <label class="form-label">Tipo de Corte</label>
                <select id="tipo_corte" class="form-select">
                    <option value="dia">Día</option>
                    <option value="semana">Semana</option>
                    <option value="mes">Mes</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label class="form-label">Fecha</label>
                <input type="date" id="fecha_corte" class="form-control">
            </div>
            <div class="col-md-3 mb-2 d-flex align-items-end">
                <button class="btn btn-outline-dark w-100" onclick="generarCorte()">
                    <i class="fas fa-sync-alt me-1"></i> Generar
                </button>
            </div>
            <div class="col-md-3 mb-2 d-flex align-items-end">
                <button class="btn btn-outline-dark w-100" id="btnExportar" disabled onclick="exportarExcel()">
                    <i class="fas fa-file-excel me-1"></i> Exportar
                </button>
            </div>
        </div>

        <div id="loading" class="text-center my-4" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Generando reporte...</p>
        </div>

        <div id="resultado_corte">
            <div class="alert alert-light border text-center">
                Seleccione los parámetros y haga clic en "Generar"
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<script>
// Variable global para almacenar los datos del corte
let datosCorteActual = null;

// Función para generar el corte
async function generarCorte() {
    const loading = document.getElementById('loading');
    const resultado = document.getElementById('resultado_corte');
    const btnExportar = document.getElementById('btnExportar');
    
    loading.style.display = 'block';
    resultado.innerHTML = '';
    btnExportar.disabled = true;
    
    try {
        const tipo = document.getElementById('tipo_corte').value;
        const fecha = document.getElementById('fecha_corte').value;
        
        const response = await fetch(`/ventas/generar_corte?tipo=${tipo}&fecha=${fecha}`);
        if (!response.ok) {
            throw new Error(await response.text());
        }
        const data = await response.json();
        
        if (data.error) {
            showError(data.error);
            return;
        }

        // Guardar datos para exportar
        datosCorteActual = data;
        btnExportar.disabled = false;
        
        renderCorte(data);
        
    } catch (error) {
        showError("Error al generar el corte: " + error.message);
        console.error(error);
    } finally {
        loading.style.display = 'none';
    }
}

// Función para renderizar los resultados del corte
function renderCorte(data) {
    const resultado = document.getElementById('resultado_corte');
    
    const formatMoney = (value) => {
        const num = parseFloat(value) || 0;
        return num.toFixed(2);
    };

    let html = `
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-transparent border-0">
                <h5 class="text-center"><i class="far fa-calendar-alt me-2"></i>Corte del ${data.fecha_inicio} al ${data.fecha_fin}</h5>
            </div>
            <div class="card-body">
                <div class="row justify-content-center">
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <p class="mb-1"><small class="text-muted">Total Ventas</small></p>
                                <h4>$${formatMoney(data.total_ventas)}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <p class="mb-1"><small class="text-muted">Ganancias</small></p>
                                <h4>$${formatMoney(data.total_ganancias)}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <p class="mb-1"><small class="text-muted">N° de Ventas</small></p>
                                <h4>${data.num_ventas}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <p class="mb-1"><small class="text-muted">Margen</small></p>
                                <h4>${(data.total_ganancias / data.total_ventas * 100 || 0).toFixed(2)}%</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;

    // Gráfica de presentaciones más vendidas
    html += `
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-transparent border-0">
                <h5 class="text-center"><i class="fas fa-boxes me-2"></i>Presentaciones Más Vendidas</h5>
            </div>
            <div class="card-body">
                <canvas id="graficaPresentaciones" height="200"></canvas>
                <div class="mt-3">
                    <table class="table">
                        <thead class="border-bottom">
                            <tr>
                                <th>Presentación</th>
                                <th class="text-end">Veces Vendida</th>
                                <th class="text-end">Cantidad Total</th>
                            </tr>
                        </thead>
                        <tbody>`;
    
    data.presentaciones_mas_vendidas.forEach(p => {
        html += `
            <tr class="border-bottom">
                <td>${p.presentacion}</td>
                <td class="text-end">${p.repeticiones}</td>
                <td class="text-end">${p.cantidad_total}</td>
            </tr>`;
    });
    
    html += `</tbody></table></div></div></div>`;

    // Gráfica de galletas más vendidas
    html += `
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-transparent border-0">
                <h5 class="text-center"><i class="fas fa-cookie me-2"></i>Galletas Más Vendidas</h5>
            </div>
            <div class="card-body">
                <canvas id="graficaGalletas" height="200"></canvas>
                <div class="mt-3">
                    <table class="table">
                        <thead class="border-bottom">
                            <tr>
                                <th>Galleta</th>
                                <th class="text-end">Cantidad</th>
                                <th class="text-end">Total Ventas</th>
                            </tr>
                        </thead>
                        <tbody>`;
    
    data.galletas_mas_vendidas.forEach(g => {
        html += `
            <tr class="border-bottom">
                <td>${g.nombre}</td>
                <td class="text-end">${g.total_descontado}</td>
                <td class="text-end">$${formatMoney(g.total_venta)}</td>
            </tr>`;
    });
    
    html += `</tbody></table></div></div></div>`;

    // Detalle de ventas
    html += `
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0">
                <h5 class="text-center"><i class="fas fa-receipt me-2"></i>Detalle de Ventas</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead class="border-bottom">
                            <tr>
                                <th>ID</th>
                                <th>Fecha/Hora</th>
                                <th class="text-end">Total</th>
                                <th class="text-end">Ganancia</th>
                            </tr>
                        </thead>
                        <tbody>`;
    
    data.detalle_ventas.forEach(venta => {
        html += `
            <tr class="border-bottom">
                <td>${venta.id}</td>
                <td>${venta.fecha}</td>
                <td class="text-end">$${formatMoney(venta.total)}</td>
                <td class="text-end">$${formatMoney(venta.ganancia)}</td>
            </tr>`;
    });
    
    html += `</tbody></table></div></div></div>`;
    
    resultado.innerHTML = html;

    // Crear gráficas después de que el HTML se haya renderizado
    setTimeout(() => {
        crearGraficaPresentaciones({
            labels: data.presentaciones_mas_vendidas.map(p => p.presentacion),
            data: data.presentaciones_mas_vendidas.map(p => p.repeticiones),
            cantidades: data.presentaciones_mas_vendidas.map(p => p.cantidad_total)
        });
        
        crearGraficaGalletas({
            labels: data.galletas_mas_vendidas.map(g => g.nombre),
            data: data.galletas_mas_vendidas.map(g => g.total_descontado),
            ventas: data.galletas_mas_vendidas.map(g => g.total_venta)
        });
    }, 100);
}

// Función para exportar a Excel
function exportarExcel() {
    if (!datosCorteActual) {
        showError("No hay datos para exportar");
        return;
    }

    try {
        const wb = XLSX.utils.book_new();
        
        // Hoja 1: Resumen
        const resumenData = [
            ["Corte de Ventas", "", "", ""],
            ["Desde:", datosCorteActual.fecha_inicio, "Hasta:", datosCorteActual.fecha_fin],
            ["Total Ventas:", `$${datosCorteActual.total_ventas.toFixed(2)}`, "Total Ganancias:", `$${datosCorteActual.total_ganancias.toFixed(2)}`],
            ["Número de Ventas:", datosCorteActual.num_ventas, "Margen:", `${(datosCorteActual.total_ganancias / datosCorteActual.total_ventas * 100 || 0).toFixed(2)}%`],
            [],
            ["Presentaciones Más Vendidas", "Repeticiones", "Cantidad Total"],
            ...datosCorteActual.presentaciones_mas_vendidas.map(p => [
                p.presentacion, p.repeticiones, p.cantidad_total
            ]),
            [],
            ["Galletas Más Vendidas", "Cantidad Descontada", "Total Ventas"],
            ...datosCorteActual.galletas_mas_vendidas.map(g => [
                g.nombre, g.total_descontado, `$${g.total_venta.toFixed(2)}`
            ])
        ];
        
        const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
        XLSX.utils.book_append_sheet(wb, wsResumen, "Resumen");
        
        // Hoja 2: Detalle de Ventas
        const detalleData = [
            ["ID Venta", "Fecha/Hora", "Total", "Ganancia"],
            ...datosCorteActual.detalle_ventas.map(v => [
                v.id, v.fecha, `$${v.total.toFixed(2)}`, `$${v.ganancia.toFixed(2)}`
            ])
        ];
        
        const wsDetalle = XLSX.utils.aoa_to_sheet(detalleData);
        XLSX.utils.book_append_sheet(wb, wsDetalle, "Detalle Ventas");
        
        const fechaReporte = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(wb, `Corte_Ventas_${fechaReporte}.xlsx`);
        
    } catch (error) {
        showError("Error al exportar a Excel: " + error.message);
        console.error(error);
    }
}

// Función para crear gráfica de presentaciones
function crearGraficaPresentaciones(datos) {
    const ctx = document.getElementById('graficaPresentaciones').getContext('2d');
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: datos.labels,
            datasets: [{
                label: 'Veces vendida',
                data: datos.data,
                backgroundColor: 'rgba(100, 100, 100, 0.2)',
                borderColor: 'rgba(100, 100, 100, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            return `Cantidad total: ${datos.cantidades[index]}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Número de veces vendida'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Tipo de presentación'
                    }
                }
            }
        }
    });
}

// Función para crear gráfica de galletas
function crearGraficaGalletas(datos) {
    const ctx = document.getElementById('graficaGalletas').getContext('2d');
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: datos.labels,
            datasets: [{
                label: 'Cantidad descontada',
                data: datos.data,
                backgroundColor: 'rgba(150, 150, 150, 0.2)',
                borderColor: 'rgba(150, 150, 150, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            return `Total ventas: $${datos.ventas[index].toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Total de galletas vendidas'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Tipos de galletas'
                    }
                }
            }
        }
    });
}

// Función para mostrar errores
function showError(message) {
    const resultado = document.getElementById('resultado_corte');
    resultado.innerHTML = `
        <div class="alert alert-light border text-center">
            <i class="fas fa-exclamation-circle me-2"></i>${message}
        </div>`;
}

// Cargar fecha actual al iniciar
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('fecha_corte').valueAsDate = new Date();
});
</script>

<style>
    .card {
        border-radius: 0.5rem;
    }
    .table {
        border-collapse: separate;
        border-spacing: 0;
    }
    .table thead th {
        font-weight: 500;
        background-color: #f9f9f9;
    }
    canvas {
        max-height: 300px;
    }
    .btn-outline-dark:hover {
        background-color: #f8f9fa;
    }
</style>

{% endblock %}