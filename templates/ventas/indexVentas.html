{% extends "layoutVentas.html" %}
{% import "_macros.html" as macros %}
{% block container %}

<input type="hidden" id="csrf_token" value="{{ csrf_token() }}">

<div class="container">
    <h2 class="text-center mb-4">Registrar Venta</h2>

    <!-- Grid de galletas -->
    <h3 class="text-center mb-4">Selecciona Galletas</h3>
    <div class="row g-4 mb-4" id="galletas-grid">
        {% for galleta in galletas %}
        <div class="col-md-4 col-lg-3">
            <div class="card h-100 shadow-sm galleta-card" data-nombre="{{ galleta.nombre }}" data-precio="{{ galleta.precio }}">
                <div class="card-header bg-transparent d-flex justify-content-between border-0">
                    <span class="badge bg-secondary">#{{ galleta.id }}</span>
                    <span class="text-muted small">${{ "%.2f"|format(galleta.precio) }}</span>
                </div>

                <div class="img-container">
                    <img src="{{ url_for('static', filename=galleta.url_imagen) if galleta.url_imagen else url_for('static', filename='img/galleta.png') }}"
                    class="img-fluid" alt="{{ galleta.nombre }}">
                </div>

                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-center">{{ galleta.nombre }}</h5>

                    <!-- Selección de presentación y cantidad -->
                    <div class="mb-3">
                        <label for="presentacion-{{ loop.index }}" class="form-label">Presentación:</label>
                        <select id="presentacion-{{ loop.index }}" class="form-select">
                            <option value="pieza">Pieza (1 unidad)</option>
                            <option value="gramos">Gramos (múltiplos de 100g)</option>
                            <option value="700g">Paquete 700g (7 unidades)</option>
                            <option value="1kg">Paquete 1kg (10 unidades)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cantidad-{{ loop.index }}" class="form-label">Cantidad:</label>
                        <input type="number" id="cantidad-{{ loop.index }}" class="form-control" value="1" min="1">
                    </div>
                    <button class="btn btn-outline-dark w-100 agregar-btn mt-auto" data-nombre="{{ galleta.nombre }}" data-index="{{ loop.index }}">
                        <i class="fas fa-plus me-1"></i> Agregar
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="error-display" class="alert alert-light border text-center mb-3" style="display: none;"></div>

    <h3 class="text-center mb-3">Carrito</h3>
    <ul id="carrito" class="list-group mb-3"></ul>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 id="total" class="mb-0">Total: $0.00</h4>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-4 mb-3">
            <label for="monto_recibido" class="form-label">Monto recibido:</label>
            <input type="number" id="monto_recibido" class="form-control" step="0.01" min="0">
        </div>
        <div class="col-md-3 mb-3 d-flex align-items-end">
            <button class="btn btn-outline-success w-100" onclick="guardarVenta(false)">
                <i class="fas fa-save me-1"></i> Guardar
            </button>
        </div>
        <div class="col-md-3 mb-3 d-flex align-items-end">
            <button class="btn btn-outline-primary w-100" onclick="guardarVenta(true)">
                <i class="fas fa-print me-1"></i> Imprimir
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    actualizarCarrito();

    document.querySelectorAll('.agregar-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const nombreGalleta = this.dataset.nombre;
            const index = this.dataset.index;
            const presentacion = document.getElementById(`presentacion-${index}`).value;
            const cantidad = document.getElementById(`cantidad-${index}`).value;

            agregarProducto(nombreGalleta, presentacion, cantidad);
        });
    });
});

async function agregarProducto(nombreGalleta, presentacion, cantidad) {
    const errorDisplay = document.getElementById('error-display');
    errorDisplay.style.display = 'none';
    
    try {
        let csrfToken = document.getElementById('csrf_token').value;

        if (!nombreGalleta || !presentacion || !cantidad) {
            throw new Error('Todos los campos son requeridos');
        }

        cantidad = parseInt(cantidad);
        if (isNaN(cantidad) || cantidad <= 0) {
            throw new Error('La cantidad debe ser un número positivo');
        }

        if (presentacion === 'gramos' && cantidad % 100 !== 0) {
            throw new Error('Para venta por gramos, la cantidad debe ser múltiplo de 100');
        }

        let response = await fetch('/ventas/agregar_producto', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                nombre_galleta: nombreGalleta, 
                presentacion: presentacion, 
                cantidad: cantidad 
            })
        });

        let data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Error al agregar producto');

        actualizarCarrito();

        const card = document.querySelector(`.galleta-card[data-nombre="${nombreGalleta}"]`);
        card.classList.add('added');
        setTimeout(() => card.classList.remove('added'), 500);
        
    } catch (error) {
        errorDisplay.textContent = error.message;
        errorDisplay.style.display = 'block';
    }
}

async function actualizarCarrito() {
    try {
        let response = await fetch('/ventas/carrito');
        if (!response.ok) throw new Error('Error al obtener carrito');
        let carrito = await response.json();
        
        let lista = document.getElementById('carrito');
        lista.innerHTML = '';
        let total = 0;

        if (carrito.length === 0) {
            lista.innerHTML = '<li class="list-group-item text-center">El carrito está vacío</li>';
            document.getElementById('total').innerText = 'Total: $0.00';
            return;
        }

        carrito.forEach((item) => {
            let subtotal = parseFloat(item.subtotal);
            total += subtotal;

            let listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';

            let presentacionTexto = '';
            switch(item.presentacion) {
                case 'pieza': presentacionTexto = `${item.cantidad} pieza${item.cantidad > 1 ? 's' : ''}`; break;
                case '700g': presentacionTexto = `${item.cantidad} paquete${item.cantidad > 1 ? 's' : ''} 700g`; break;
                case '1kg': presentacionTexto = `${item.cantidad} paquete${item.cantidad > 1 ? 's' : ''} 1kg`; break;
                case 'gramos': presentacionTexto = `${item.cantidad * 100}g`; break;
                default: presentacionTexto = item.presentacion;
            }

            listItem.innerHTML = `
                <div>
                    <strong>${item.nombre_galleta}</strong> (${presentacionTexto})<br>
                    <small class="text-muted">Precio unitario: $${parseFloat(item.precio_unitario).toFixed(2)}</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="me-3">$${subtotal.toFixed(2)}</span>
                    <button class="btn btn-outline-danger btn-sm" onclick="eliminarProducto('${item.nombre_galleta}', '${item.presentacion}')">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            
            lista.appendChild(listItem);
        });

        document.getElementById('total').innerText = `Total: $${total.toFixed(2)}`;
        document.getElementById('monto_recibido').value = total.toFixed(2);
        
    } catch (error) {
        console.error('Error en actualizarCarrito:', error);
    }
}

async function eliminarProducto(nombreGalleta, presentacion) {
    const errorDisplay = document.getElementById("error-display");
    errorDisplay.style.display = "none";
    
    try {
        let csrfToken = document.getElementById("csrf_token").value;

        let response = await fetch("/ventas/eliminar_producto", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({ nombre_galleta: nombreGalleta, presentacion: presentacion })
        });

        let data = await response.json();
        if (!response.ok) throw new Error(data.error || "Error al eliminar producto");

        actualizarCarrito();
    } catch (error) {
        errorDisplay.textContent = error.message;
        errorDisplay.style.display = "block";
    }
}

async function guardarVenta(imprimirTicket) {
    const errorDisplay = document.getElementById("error-display");
    errorDisplay.style.display = "none";
    
    try {
        let montoRecibido = parseFloat(document.getElementById("monto_recibido").value);
        let csrfToken = document.getElementById("csrf_token").value;

        if (isNaN(montoRecibido)) throw new Error("Ingrese un monto válido");

        let response = await fetch("/ventas/guardar_venta", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({
                monto_recibido: montoRecibido.toFixed(2),
                imprimir_ticket: imprimirTicket
            })
        });

        let data = await response.json();
        if (!response.ok) throw new Error(data.error || "Error al procesar venta");

        actualizarCarrito();
        document.getElementById("monto_recibido").value = "";

        errorDisplay.className = "alert alert-light border text-center";
        errorDisplay.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>Venta guardada. Cambio: $${parseFloat(data.cambio).toFixed(2)}`;
        errorDisplay.style.display = "block";

        setTimeout(() => {
            errorDisplay.style.display = "none";
        }, 5000);

        if (imprimirTicket && data.venta_id) {
            imprimirTicketVenta(data.venta_id);
        }

    } catch (error) {
        errorDisplay.innerHTML = `<i class="fas fa-exclamation-circle text-danger me-2"></i>${error.message}`;
        errorDisplay.style.display = "block";
    }
}

function imprimirTicketVenta(ventaId) {
    const url = `/ventas/ticket/${ventaId}`;
    const ventanaTicket = window.open(url, '_blank');
    ventanaTicket.onload = function() {
        setTimeout(() => {
            ventanaTicket.print();
        }, 500);
    };
}
</script>

<style>
.galleta-card {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    border-radius: 0.5rem;
}

.galleta-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.galleta-card.added {
    animation: pulse 0.5s;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.img-container {
    height: 250px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
    padding: 1rem;
}

.img-container img {
    max-height: 100%;
    width: auto;
    object-fit: contain;
    border-radius: 0.25rem;
}

.list-group-item {
    transition: background-color 0.2s;
}

.btn-outline-dark:hover, .btn-outline-success:hover, .btn-outline-primary:hover {
    background-color: #f8f9fa;
}
</style>

{% endblock %}